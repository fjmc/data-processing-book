<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="generator" content="pandoc">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <meta name="author" content="João D. Ferreira">
    <meta name="author" content="Francisco M. Couto">
    <title>Processamento de dados de vias metabólicas usando ficheiros, serviços web e bases de dados</title>
    <style type="text/css">code{white-space: pre;}</style>
    <link rel="stylesheet" href="pandoc.css">
    <!--[if lt IE 9]>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
    <![endif]-->
</head>
<body>
<header>
<h1 class="title">Processamento de dados de vias metabólicas usando ficheiros, serviços web e bases de dados</h1>
<h2 class="author">João D. Ferreira</h2>
<h2 class="author">Francisco M. Couto</h2>
<h3 class="date">Faculdade de Ciências da Universidade de Lisboa<br>Versão de 2016</h3>
</header>
<div id="license">
<p><a rel="license" href="http://creativecommons.org/licenses/by/4.0/"> <img src="images/cc-88x31.png" title="Creative Commons License" /> </a> Este documento está protegido pela licença<br> <a href="http://creativecommons.org/licenses/by/4.0/">Creative Commons - Atribuição 4.0 Internacional</a></p>
</div>
<h1 id="índice">Índice</h1>
<ul>
<li><a href="#introduction">Introdução</a></li>
<li><a href="#module1">Módulo 1 – Dados de vias metabólicas</a></li>
<li><a href="#module2">Módulo 2 – Seleção simples e guardar informação em disco</a></li>
<li><a href="#module3">Módulo 3 – UniProt como serviço web</a></li>
<li><a href="#module4">Módulo 4 – Cruzamento de dados de várias fontes</a></li>
<li><a href="#module5">Módulo 5 – Seleção de informação com expressões regulares</a></li>
<li><a href="#module6">Módulo 6 – Criar uma base de dados SQL</a></li>
<li><a href="#module7">Módulo 7 – Inserção de dados CSV</a></li>
</ul>
<h1 id="introduction">Introdução</h1>
<p>O objetivo destes exercícios é munir os alunos com a capacidade e a competência para processar dados de forma automática. O tema principal destes exercícios será o processamento de dados de via metabólica, com foco sobre as proteínas que catalisam as reações químicas das vias, também conhecido como <em>enzimas</em>. Apesar de trabalharmos com vias metabólicas durante as aulas, os métodos de processamento de dados que os alunos vão aprender nesta disciplina podem ser aplicado a muitos outros tipos de dados.</p>
<h2 id="dados">Dados</h2>
<p>A figura que se segue representa os primeiros passos na glicólise, uma via metabólica que decompõe a glicose em compostos químicos mais pequenos. Esta figura inclui uma representação de cinco etapas desta via, cada uma catalisada por uma enzima diferente.</p>
<figure>
<img src="images/pathway.png" title="Exemplo de uma via metabólica" alt="Uma via metabólica" /><figcaption>Uma via metabólica</figcaption>
</figure>
<p>Para estas aulas, iremos fornecer <a href="files/metabolic_pathways.xls">um ficheiro Excel</a> com informação sobre 297 vias metabólicas. Cada linha neste arquivo contém:</p>
<ul>
<li>O identificador da via metabólica;</li>
<li>O nome da via;</li>
<li>A classe a que pertence;</li>
<li>Uma lista das enzimas que participam na via.</li>
</ul>
<p>Assim, o arquivo Excel tem 297 linhas de informação, mais uma para os cabeçalhos das colunas.</p>
<p>A imagem seguinte mostra uma imagem do ficheiro Excel e seus dados.</p>
<figure>
<img src="images/excel.png" title="Parte dos dados do ficheiro Excel" alt="Screenshot do ficheiro Excel" /><figcaption>Screenshot do ficheiro Excel</figcaption>
</figure>
<p>Esta informação foi extraída de um banco de dados online chamado <a href="http://www.genome.jp/kegg/kegg2.html">Kyoto Encyclopedia of Genes and Genome</a>. As enzimas são referidos pelo seu código UniProt. A <a href="http://www.uniprot.org/">UniProt</a> é um banco de dados de proteínas que contêm, entre uma vasta quantidade de informação, as sequências de aminoácidos das proteínas.</p>
<h2 id="processamento">Processamento</h2>
<p>Apesar de os dados serem fornecidos aos alunos na forma de ficheiro Excel, as operações de processamento de dados vão ser maioritariamente executadas com uma linguagem de programação. Nesta disciplina vamos usar <a href="http://www.python.org">Python</a>. O processamento dos dados com Python em vez de Excel oferece vários benefícios:</p>
<ul>
<li>Podemos definir um conjunto de operações a serem executadas automaticamente, as quais levariam muito tempo no Excel, uma vez que nesse programa o processamento de dados é feito maioritariamente através da interação do utilizador com a interface gráfica, e não com o uso direto de comandos;</li>
<li>Uma linguagens de programação pode lidar com tipos de dados complexos, enquanto que o Excel é principalmente orientada para cálculos numéricos.</li>
</ul>
<p>Não será necessário nenhum conhecimento profundo da programação para os exercícios das aulas, pois iremos fornecer a maior parte do código. Na verdade, os alunos não aprenderão diretamente os detalhes do Python como uma linguagem de programação, mas em vez disso, serão dadas “receitas” que contêm a maior parte da lógica necessária, com pequenos trechos de código em falta que os estudantes precisarão de preencher. No entanto, esperamos que os alunos se familiarizarem com a sintaxe de Python, seguindo alguns cursos online. Por exemplo, o <a href="https://www.codecademy.com/en/tracks/python">Codecademy</a> contém seis módulos que irão ajudar os alunos nesta tarefa (note-se que existem versões em português nesse site):</p>
<ul>
<li><a href="https://www.codecademy.com/courses/introduction-to-python-6WeG3/0/1?curriculum_id=4f89dab3d788890003000096">Python Syntax</a></li>
<li><a href="https://www.codecademy.com/courses/python-beginner-sRXwR/0/1?curriculum_id=4f89dab3d788890003000096">Strings &amp; Console Output</a></li>
<li><a href="https://www.codecademy.com/courses/python-beginner-BxUFN/0/1?curriculum_id=4f89dab3d788890003000096">Conditionals &amp; Control Flow</a></li>
<li><a href="https://www.codecademy.com/courses/python-beginner-en-pwmb1/0/1?curriculum_id=4f89dab3d788890003000096">Python Lists and Dictionaries</a></li>
<li><a href="https://www.codecademy.com/courses/python-intermediate-en-OGNHh/0/1?curriculum_id=4f89dab3d788890003000096">File Input/Output</a></li>
</ul>
<h1 id="module1">Módulo 1 – Dados de vias metabólicas</h1>
<h2 id="parte-i-notepad-e-python">Parte I: Notepad++ e Python</h2>
<h3 id="objetivos">Objetivos:</h3>
<ul>
<li>Abrir o Notepad++, escrever algum código Python e gravar o ficheiro</li>
<li>Executar o código com o interpretador Python</li>
</ul>
<h3 id="passos">Passos:</h3>
<ol type="1">
<li>No menu iniciar do Windows, abra o <code>Notepad++</code>.</li>
</ol>
<figure>
<img src="images/open-notepad.png" title="Abrir o Notepad++" alt="Abrir o Notepad++" /><figcaption>Abrir o Notepad++</figcaption>
</figure>
<ol start="2" type="1">
<li>Escreva um pequeno programa “Hello World” e grave o ficheiro no Ambiente de Trabalho (ou em qualquer outra pasta que quiser) com o nome <code>test.py</code>.</li>
</ol>
<figure>
<img src="images/hello-world.png" title="O programa &quot;Hello World&quot;" alt="O programa &quot;Hello World&quot;" /><figcaption>O programa &quot;Hello World&quot;</figcaption>
</figure>
<ol start="3" type="1">
<li>No menu iniciar, abra a linha de comandos (<code>cmd</code>).</li>
</ol>
<figure>
<img src="images/open-cmd.png" title="Abrindo a linha de comandos" alt="Abrindo a linha de comandos" /><figcaption>Abrindo a linha de comandos</figcaption>
</figure>
<ol start="4" type="1">
<li><p>No terminal (a janela com a linha de comandos), precisamos de navegar para o Ambiente de Trabalho e depois instruir o interpretador Python a executar o ficheiro <code>test.py</code>. Para tal, escreva e execute os seguintes comandos no terminal:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">cd</span> Desktop
<span class="kw">python</span> test.py</code></pre></div>
<figure>
<img src="images/hello-world-run.png" title="O output do programa &quot;Hello World&quot;" alt="O output do programa &quot;Hello World&quot;" /><figcaption>O output do programa &quot;Hello World&quot;</figcaption>
</figure></li>
<li><p>Observe o output produzido pelo Python e confirme que o terminal mostra o seguinte:</p>
<pre class="text"><code>Hello World!</code></pre></li>
</ol>
<h2 id="part-ii-iniciando-o-processamento-de-dados">Part II: Iniciando o processamento de dados</h2>
<h3 id="objetivos-1">Objetivos:</h3>
<ul>
<li>Compreender o formato CSV</li>
<li>Converter um ficheiro Excel no formato CSV</li>
<li>Compreender o significado de metadados</li>
<li>Ler ficheiros CSV com Python</li>
</ul>
<h3 id="input">Input:</h3>
<ul>
<li>Ficheiro: <a href="files/metabolic_pathways.xls">metabolic_pathways.xls</a></li>
</ul>
<h3 id="output">Output:</h3>
<ul>
<li>Ficheiro: <code>metabolic_pathways.csv</code></li>
<li><p>Terminal:</p>
<pre class="text"><code>Glycolysis / Gluconeogenesis
Citrate cycle (TCA cycle)
Pentose phosphate pathway
Pentose and glucuronate interconversions
...</code></pre></li>
</ul>
<h3 id="passos-1">Passos:</h3>
<ol type="1">
<li><p>Abra o ficheiro Excel. Tome especial atenção ao conteúdo deste ficheiro e familiarize-se com os dados que contém. Este passo é de grande importância em processamento de dados, pois permite-nos ganhar intuição sobre a informação com que estamos a lidar.</p></li>
<li><p>Remova a primeira linha, que contém os cabeçalhos das colunas. (Esta primeira linha é classificada como “metadados” uma vez que fornece informação acerca dos dados no ficheiro mas não contém, por si mesma, dados.)</p></li>
<li><p>Usando as funcionalidades do Excel, grave os dados no formato CSV usando o nome <code>metabolic_pathways.csv</code>.</p></li>
<li><p>Abra o ficheiro CSV num editor de texto (<code>Notepad++</code>) e estude o conteúdo do novo ficheiro. Por exemplo, determine qual caracter é usado para separar os vários campos, se os campos estão delimitados e como, <em>etc</em>.</p></li>
<li><p>Vamos criar um <em>script</em> Python para ler o ficheiro CSV e imprimir o nome de cada via.</p>
<ol type="a">
<li><p>Crie um ficheiro vazio e grave-o como <code>module1.py</code> na mesma pasta onde está o ficheiro <code>metabolic_pathways.csv</code>. Não esqueça a terminação <code>.py</code>, pois esta indica ao computador que o ficheiro é um <em>script</em> Python.</p></li>
<li><p>Copie e cole o código seguinte para o seu ficheiro:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> csv

f <span class="op">=</span> <span class="bu">open</span>(<span class="st">&#39;metabolic_pathways.csv&#39;</span>)   <span class="co"># Open the file</span>

paths <span class="op">=</span> csv.reader(f, delimiter<span class="op">=</span>???) <span class="co"># Create a CSV reader object</span>

<span class="cf">for</span> path <span class="op">in</span> paths: <span class="co"># For each pathway ...</span>
    <span class="bu">print</span> ???      <span class="co"># ... print its name</span></code></pre></div></li>
<li><p>Substitua todos os pontos de interrogação (<code>???</code>) por código Python apropriado.</p></li>
</ol></li>
<li><p>Corra o <code>module1.py</code> no terminal e observe o output. O output corresponde ao que estava à espera de ver?</p></li>
<li><p>Certifique-se de que mantém uma cópia do ficheiro <code>metabolic_pathways.csv</code> para si, assim como do <em>script</em> <code>module1.py</code>, de forma a que os possa usar nos próximos módulos. Por exemplo, envie-os para si por email ou faça o upload para a Dropbox.</p></li>
</ol>
<h2 id="após-a-aula">Após a aula:</h2>
<ol type="1">
<li><p>Altere o código Python para imprimir não o nome das vias mas a sua classe.</p></li>
<li><p>Verifique que alguns campos no ficheiro CSV estão delimitados por aspas (<code>&quot;</code>) e que outro não estão. Explique porquê.</p></li>
</ol>
<h1 id="module2">Módulo 2 – Seleção simples e guardar informação em disco</h1>
<h2 id="objetivos-2">Objetivos:</h2>
<ul>
<li>Transformar um critério de seleção em código Python</li>
<li>Implementar o processo de seleção em Python</li>
<li>Gravar os dados selecionados num novo ficheiro</li>
</ul>
<h2 id="input-1">Input:</h2>
<ul>
<li>Ficheiro: <a href="files/metabolic_pathways.csv">metabolic_pathways.csv</a></li>
</ul>
<h2 id="output-1">Output:</h2>
<ul>
<li>Ficheiro: <code>selected1.csv</code>
<ul>
<li>contendo os dados da via <code>hsa04210</code>.</li>
</ul></li>
<li>Ficheiro: <code>selected2.csv</code>
<ul>
<li>contendo os dados das vias <code>hsa00730</code> e <code>hsa04122</code>.</li>
</ul></li>
</ul>
<h2 id="passos-2">Passos:</h2>
<ol type="1">
<li><p>Vamos criar uma função Python que determine se o ID de uma via é <code>hsa04210</code>:</p>
<ol type="a">
<li><p>Crie um ficheiro vazio e grave-o como <code>module2.py</code> na mesma pasta onde o ficheiro <code>metabolic_pathways.csv</code> está. Não se esqueça da terminação <code>.py</code>, pois esta indica ao computador que o ficheiro é um <em>script</em> Python.</p></li>
<li><p>Copie e cole o código seguinte para o ficheiro:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="kw">def</span> filter1(path):
    path_id <span class="op">=</span> path[???]  <span class="co"># Select the column for the ID</span>

    <span class="cf">if</span> path_id <span class="op">==</span> <span class="st">&#39;???&#39;</span>: <span class="co"># Replace with the ID we are searching for</span>
        <span class="cf">return</span> <span class="va">True</span>
    <span class="cf">else</span>:
        <span class="cf">return</span> <span class="va">False</span></code></pre></div></li>
<li><p>Substitua os pontos de interrogração (<code>???</code>) por código Python apropriado.</p></li>
</ol></li>
<li><p>O código do passo anterior define uma função que vai ser executada quando for chamada, mas por si só não faz nada. Vamos adicionar mais código ao ficheiro para efetivamente usarmos a função em cada uma das vias metabólicas.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> csv

<span class="co"># Open the original file to read all pathways</span>
file_to_read <span class="op">=</span> <span class="bu">open</span>(<span class="st">&#39;metabolic_pathways.csv&#39;</span>)
paths <span class="op">=</span> csv.reader(file_to_read, delimiter<span class="op">=</span>???)

<span class="co"># Open the file to save the selection</span>
<span class="co"># The &#39;w&#39; instructs Python that we want to write on this file</span>
file_to_write <span class="op">=</span> <span class="bu">open</span>(<span class="st">&#39;selected1.csv&#39;</span>, <span class="st">&#39;w&#39;</span>)
w <span class="op">=</span> csv.writer(file_to_write, delimiter<span class="op">=</span>???)

<span class="cf">for</span> path <span class="op">in</span> paths:
    <span class="cf">if</span> filter1(path):
        w.writerow(path)

<span class="co"># Close the file</span>
file_to_write.close()</code></pre></div></li>
<li><p>Corra o <em>script</em> <code>module2.py</code> e estude o novo ficheiro que foi criado. Verifique que o seu conteúdo corresponde ao que esperava.</p></li>
<li><p>Edite o ficheiro <code>module2.py</code> criando agora uma nova função <code>filter2</code> que seleciona as vias onde a enzima Q9Y697 participa. Se necessário, consulte a documentação para a função <code>str.split</code> em <a href="https://docs.python.org/2/library/stdtypes.html#str.split" class="uri">https://docs.python.org/2/library/stdtypes.html#str.split</a>. Vamos implementar esta funcionalidade em dois passos:</p>
<ol type="a">
<li><p>Crie a nova função <code>filter2</code>:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="kw">def</span> filter2(path):
    field <span class="op">=</span> path[???] <span class="co"># Select the column for the list of enzymes</span>

    <span class="co"># Break that information into a list</span>
    enzyme_list <span class="op">=</span> <span class="bu">str</span>.split(field, ???)

    <span class="co"># enzyme_list is now a list of strings, such as follows:</span>
    <span class="co"># [&#39;H9EC08&#39;, &#39;P03905&#39;, &#39;G9LG04&#39;, &#39;P03901&#39;]</span>

    <span class="co"># Return True if our selected enzyme is in that list</span>
    <span class="cf">if</span> <span class="st">&#39;???&#39;</span> <span class="op">in</span> enzyme_list:
        <span class="cf">return</span> <span class="va">True</span>
    <span class="cf">else</span>:
        <span class="cf">return</span> <span class="va">False</span></code></pre></div></li>
<li><p>Altere <code>'selected1.csv'</code> para <code>'selected2.csv'</code>. Esta modifação é essencial para que o novo ficheiro produzido não substitua o que já existe.</p></li>
</ol></li>
<li><p>Corra o <code>module2.py</code> outra vez e estude o ficheiro que foi produzido. Verifique que o seu conteúdo corresponde ao que esperava: em particular, assegure-se que a enzima Q9Y697 pertence a todas as vias selecionadas.</p></li>
<li><p>Certifique-se de que mantém uma cópia dos ficheiros <code>selected1.csv</code> e <code>selected2.csv</code> para si, assim como do <em>script</em> <code>module2.py</code>, de forma a que os possa usar nos próximos módulos. Por exemplo, envie-os para si por email ou faça o upload para a Dropbox.</p></li>
</ol>
<h2 id="após-a-aula-1">Após a aula:</h2>
<ol type="1">
<li><p>Crie uma terceira função <code>filter3</code> que seleciona as vias que fazem parte da classe “Human Diseases; Cancers”.</p></li>
<li><p>Usando a função pré-existente <code>len</code>, que devolve o número de elementos numa lista, crie a função <code>filter4</code> que seleciona as vias que contêm no máximo 10 enzimas. A documentação para esta função pode ser encontrada em <a href="https://docs.python.org/2/library/functions.html#len" class="uri">https://docs.python.org/2/library/functions.html#len</a></p></li>
</ol>
<p><strong>Nota</strong>: para ler e escrever ficheiros CSV em Python, usámos (e vamos usar mais vezes) o módulo <code>csv</code>. Este módulo permite especificar o formato do ficheiro a ler e escrever, <em>e.g.</em> qual o caracter a usar para separar os campos e para os delimitar. Deve familiarizar-se com este módulo por si mesmo lendo a documentação em <a href="https://docs.python.org/2/library/csv.html" class="uri">https://docs.python.org/2/library/csv.html</a>.</p>
<h1 id="module3">Módulo 3 – UniProt como serviço web</h1>
<h2 id="objetivos-3">Objetivos:</h2>
<ul>
<li>Reconhecer a importância das fontes de dados externas</li>
<li>Usar um serviço web através de código Python</li>
<li>Processar a informação proveniente de um serviço web</li>
</ul>
<h2 id="input-2">Input:</h2>
<ul>
<li>Ficheiro: <a href="files/selected2.csv">selected2.csv</a>
<ul>
<li>criado no módulo anterior</li>
</ul></li>
</ul>
<h2 id="output-2">Output:</h2>
<ul>
<li>Ficheiro: <code>sequences.csv</code>
<ul>
<li>contendo as sequências de aminoácidos de cada enzima</li>
</ul></li>
</ul>
<h2 id="passos-3">Passos:</h2>
<ol type="1">
<li><p>Abra o URL <a href="http://www.uniprot.org/uniprot/P12345.fasta" class="uri">http://www.uniprot.org/uniprot/P12345.fasta</a> no <em>browser</em> e estude o formato FASTA. Altere o identificador do link de <code>P12345</code> para outro à sua escolha e estude o seu conteúdo e quais as diferenças entre os dois.</p></li>
<li><p>Num <em>script</em> Python chamado <code>module3.py</code>, crie uma função chamada <code>get_sequence</code> que recebe o identificador de uma proteína e devolve a sua sequência de aminoácidos. Esta função:</p>
<ol type="a">
<li><p>abre o URL mencionado acima,</p></li>
<li><p>lê o conteúdo acessível por esse URL,</p></li>
<li><p>extrai a sequência de aminoácidos, e</p></li>
<li><p>junta todas as linhas numa só, de forma a devolver apenas uma <em>string</em>.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> urllib <span class="co"># This module contains functions to read URLs</span>

<span class="kw">def</span> get_sequence(identifier):
    <span class="co"># Establish the URL to open</span>
    url <span class="op">=</span> <span class="st">&#39;http://www.uniprot.org/uniprot/&#39;</span> <span class="op">+</span> ??? <span class="op">+</span> <span class="st">&#39;.fasta&#39;</span>

    <span class="co"># Open the URL</span>
    f <span class="op">=</span> urllib.urlopen(url)

    <span class="co"># Read all the lines into a list</span>
    lines <span class="op">=</span> f.readlines()

    <span class="co"># Ignore the first line, which contains metadata</span>
    <span class="kw">del</span> lines[<span class="dv">0</span>]

    <span class="co"># Join all the remaining lines into a single string</span>
    sequence <span class="op">=</span> <span class="bu">str</span>.join(<span class="st">&quot;&quot;</span>, lines)

    <span class="co"># Remove the line ends (the &quot;enter&quot; used to start the next line)</span>
    <span class="co"># This line end is represented as \n</span>
    sequence <span class="op">=</span> <span class="bu">str</span>.replace(sequence, <span class="st">&#39;</span><span class="ch">\n</span><span class="st">&#39;</span>, <span class="st">&#39;&#39;</span>)

    <span class="co"># Return the sequence</span>
    <span class="cf">return</span> ???</code></pre></div></li>
</ol></li>
<li><p>Vamos experimentar executar a função com um pequeno número de proteínas. Para tal, adicione as seguintes linhas ao <em>script</em> Python, substituindo <code>???</code> pelos identificadores que quiser:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">sequence1 <span class="op">=</span> get_sequence(<span class="st">&#39;P12345&#39;</span>)
sequence2 <span class="op">=</span> get_sequence(<span class="st">&#39;???&#39;</span>)
sequence3 <span class="op">=</span> get_sequence(<span class="st">&#39;???&#39;</span>)

<span class="bu">print</span> <span class="st">&quot;SEQUENCE 1:</span><span class="ch">\n</span><span class="st">&quot;</span> <span class="op">+</span> sequence1 <span class="op">+</span> <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>
<span class="bu">print</span> <span class="st">&quot;SEQUENCE 2:</span><span class="ch">\n</span><span class="st">&quot;</span> <span class="op">+</span> sequence2 <span class="op">+</span> <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>
<span class="bu">print</span> <span class="st">&quot;SEQUENCE 3:</span><span class="ch">\n</span><span class="st">&quot;</span> <span class="op">+</span> sequence3 <span class="op">+</span> <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span></code></pre></div></li>
<li><p>Agora que já vimos como utilizar a função, vamos ler as enzimas do ficheiro <code>selected2.csv</code> e determinar as suas sequências de aminoácidos.</p>
<ol type="a">
<li><p>Remova ou comente as linhas do passo 3.</p></li>
<li><p>Substitua-as por:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> csv

<span class="co"># Open the output file from the previous module</span>
f <span class="op">=</span> <span class="bu">open</span>(<span class="st">&#39;selected2.csv&#39;</span>)
paths <span class="op">=</span> csv.reader(f, delimiter<span class="op">=</span>???)

<span class="co"># Start with an empty list of enzymes</span>
enzymes <span class="op">=</span> []

<span class="co"># Then:</span>
<span class="co"># - read the information of each pathway,</span>
<span class="co"># - extract the list of enzymes of each pathway, and</span>
<span class="co"># - append each enzyme to the list of enzymes</span>
<span class="cf">for</span> path <span class="op">in</span> paths:
    enzymes_field <span class="op">=</span> path[???] <span class="co"># The field of the enzymes</span>

    <span class="co"># Split the enzymes into a list, as in module 2</span>
    enzymes_in_this_path <span class="op">=</span> <span class="bu">str</span>.split(enzymes_field, ???)

    <span class="co"># Append each one into the master enzyme list</span>
    <span class="cf">for</span> e <span class="op">in</span> enzymes_in_this_path:
        enzymes.append(e)</code></pre></div></li>
</ol></li>
<li><p>Agora que temos uma lista de enzimas, podemos usá-la juntamente com a função que criamos anteriormente para obter as suas sequências de aminoácidos. Vamos gravar esta informação num novo ficheiro <code>sequences.csv</code>. Para tal, continue a adicionar códugo ao <em>script</em> <code>module3.py</code>:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">f <span class="op">=</span> <span class="bu">open</span>(<span class="st">&#39;sequences.csv&#39;</span>, <span class="st">&#39;w&#39;</span>)
w <span class="op">=</span> csv.writer(f, delimiter<span class="op">=</span>???)

<span class="cf">for</span> e <span class="op">in</span> enzymes:
    seq <span class="op">=</span> get_sequence(e)
    w.writerow([e, seq])

f.close()</code></pre></div></li>
<li><p>Execute o código e estude o conteúdo do novo ficheiro (<code>sequences.csv</code>). Corresponde ao que esperava ver?</p></li>
<li><p>Certifique-se de que mantém uma cópia do ficheiro <code>sequences.csv</code> para si, assim como do <em>script</em> <code>module3.py</code>, de forma a que os possa usar nos próximos módulos. Por exemplo, envie-os para si por email ou faça o upload para a Dropbox.</p></li>
</ol>
<h2 id="após-a-aula-2">Após a aula:</h2>
<ol type="1">
<li>Verifique que no ficheiro <code>sequences.csv</code> algumas enzimas aparecem repetidas. Tente explicar porquê.</li>
</ol>
<h1 id="module4">Módulo 4 – Cruzamento de dados de várias fontes</h1>
<h2 id="objetivos-4">Objetivos:</h2>
<ul>
<li>Usar dicionários para associar informação</li>
<li>Cruzar dados de diversas fontes</li>
</ul>
<h2 id="input-3">Input:</h2>
<ul>
<li>Ficheiro: <a href="files/selected2.csv">selected2.csv</a>
<ul>
<li>criado no módulo 2</li>
</ul></li>
<li>Ficheiro: <a href="files/sequences.csv">sequences.csv</a>
<ul>
<li>criado no módulo 3</li>
</ul></li>
</ul>
<h2 id="output-3">Output:</h2>
<ul>
<li>Ficheiro: <code>paths_enzymes.csv</code></li>
</ul>
<h2 id="passos-4">Passos:</h2>
<ol type="1">
<li><p>Comece por criar um novo <em>script</em> <code>module4.py</code> vazio.</p></li>
<li><p>Vamos primeiro ler o ficheiro <code>sequences.csv</code> para construir um dicionário onde cada enzima é associada à sua própria sequência. Para tal, adicione ao <em>script</em> o seguinte código, substituindo os pontos de interrogação:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> csv

<span class="co"># Read the CSV file</span>
f <span class="op">=</span> <span class="bu">open</span>(<span class="st">&#39;sequences.csv&#39;</span>)
enzymes <span class="op">=</span> csv.reader(f, delimiter<span class="op">=</span>???)

<span class="co"># Create an empty dictionary that we will populate as we read the CSV</span>
<span class="co"># file</span>
dict_sequences <span class="op">=</span> {}

<span class="co"># For each of the enzymes in the file, associate the enzyme with its</span>
<span class="co"># sequence</span>
<span class="cf">for</span> enzyme <span class="op">in</span> enzymes:
    enzyme_id <span class="op">=</span> enzyme[???] <span class="co"># The ID of this enzyme</span>
    seq <span class="op">=</span> enzyme[???]       <span class="co"># The aminoacid sequence of this enzyme</span>
    dict_sequences[enzyme_id] <span class="op">=</span> seq</code></pre></div></li>
<li><p>Em seguida, vamos ler o ficheiro <code>selected2.csv</code> e associar a cada via uma lista das suas enzimas Também aqui vamos usar um dicionário.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="co"># Read the CSV file</span>
f <span class="op">=</span> <span class="bu">open</span>(<span class="st">&#39;selected2.csv&#39;</span>)
paths <span class="op">=</span> csv.reader(f, delimiter<span class="op">=</span>???)

<span class="co"># Create an empty dictionary that we will populate as we read the CSV</span>
<span class="co"># file</span>
dict_paths <span class="op">=</span> {}

<span class="co"># For each pathway in that file:</span>
<span class="co"># - extract the list of enzymes in the pathway</span>
<span class="co"># - associate the pathway with this list of enzymes</span>
<span class="cf">for</span> path <span class="op">in</span> paths:
    path_id <span class="op">=</span> path[???] <span class="co"># The ID of the pathways</span>
    enzymes <span class="op">=</span> path[???] <span class="co"># The field of the enzymes</span>

    <span class="co"># Break that information into a list</span>
    enzyme_list <span class="op">=</span> <span class="bu">str</span>.split(enzymes, ???)

    <span class="co"># Associate the pathway ID with the corresponding list of enzymes</span>
    dict_paths[???] <span class="op">=</span> ???</code></pre></div></li>
<li><p>Agora que temos os dois dicionários, podemos percorrer cada via e cada enzima de cada via de forma a criar um ficheiro CSV que cruza a informação, associando a cada via as sequências de aminoácidos das suas enzimas. Para tal, adicione o seguinte ao seu <em>script</em>:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="co"># Open a file to save the output</span>
f <span class="op">=</span> <span class="bu">open</span>(<span class="st">&#39;paths_enzymes.csv&#39;</span>, <span class="st">&#39;w&#39;</span>)
w <span class="op">=</span> csv.writer(f, delimiter<span class="op">=</span>???)

<span class="co"># For each pathway and each enzyme that it contains</span>
<span class="cf">for</span> path_id <span class="op">in</span> dict_paths :
    <span class="co"># Let&#39;s print some debugging information</span>
    <span class="bu">print</span> <span class="st">&#39;Processing pathway with ID &#39;</span> <span class="op">+</span> path_id

    <span class="co"># Retrieve the list of enzymes associated with this pathway</span>
    enzyme_list <span class="op">=</span> dict_paths[???]

    <span class="co"># Now that we have the list of enzymes, associate the pathway with each</span>
    <span class="co"># aminoacid sequence</span>
    <span class="cf">for</span> enzyme_id <span class="op">in</span> enzyme_list:
        <span class="co"># Some more debugging information</span>
        <span class="bu">print</span> <span class="st">&#39;  enzyme = &#39;</span> <span class="op">+</span> enzyme_id

        <span class="co"># Retrieve the sequence associated with this enzyme</span>
        seq <span class="op">=</span> dict_sequences[???]

        <span class="co"># Write this row to the CSV file</span>
        w.writerow([path_id, seq])</code></pre></div></li>
<li><p>Corra o código e estude o conteúdo do ficheiro que foi criado (<code>paths_enzymes.csv</code>). Corresponde ao que estava à espera?</p></li>
<li><p>Certifique-se de que mantém uma cópia do ficheiro <code>paths_enzymes.csv</code> para si, assim como do <em>script</em> <code>module4.py</code>, de forma a que os possa usar nos próximos módulos. Por exemplo, envie-os para si por email ou faça o upload para a Dropbox.</p></li>
</ol>
<h2 id="após-a-aula-3">Após a aula:</h2>
<ol type="1">
<li>Altere o critério de seleção usado para criar o ficheiro <code>selected2.csv</code> (por exemplo selecionando as vias com um máximo de 10 enzimas, como proposto no módulo 2). Em seguida altere o código de hoje para acomodar esta alteração.</li>
</ol>
<h1 id="module5">Módulo 5 – Seleção de informação com expressões regulares</h1>
<h2 id="objetivos-5">Objetivos:</h2>
<ul>
<li>Desenhar expressões regular para representar vários critérios de seleção</li>
<li>Usar o módulo <code>re</code> para criar e utilizar expressões regular</li>
<li>Procurar por motivos de aminoácidos nas sequências das enzimas</li>
</ul>
<h2 id="input-4">Input:</h2>
<ul>
<li>Ficheiro: <a href="files/sequences.csv">sequences.csv</a>
<ul>
<li>criado no módulo 3</li>
</ul></li>
</ul>
<h2 id="output-4">Output:</h2>
<ul>
<li>Ficheiro: <code>relevant_sequences_1.csv</code></li>
<li>Ficheiro: <code>relevant_sequences_2.csv</code></li>
<li>Ficheiro: <code>relevant_sequences_3.csv</code></li>
</ul>
<h2 id="passos-5">Passos:</h2>
<ol type="1">
<li><p>Neste módulo, vamos usar expressões regulares para procurar enzimas cujas sequências de aminoácidos satisfazem certos padrões.</p>
<ol type="a">
<li><p>Consulte a <a href="http://www.cheat-sheets.org/saved-copy/regular_expressions_cheat_sheet.png">folha de mnemónicas de expressões regulares</a>.</p></li>
<li><p>Pode ainda encontrar a correspondência entre cada aminoácido e a seu código de 1 letra <a href="http://bio100.class.uic.edu/lectures/aminoacids01.jpg">neste quadro</a>.</p></li>
<li><p>Familiarize-se com estes dois quadros.</p></li>
</ol></li>
<li><p>Começamos por ler o conteúdo do ficheiro <code>sequences.csv</code> e por criar um dicionário que associa as enzimas às suas sequências de aminoácidos, tal como fizemos no módulo anterior. Crie o <em>script</em> <code>module5.py</code>:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> csv

<span class="co"># Read the CSV file</span>
f <span class="op">=</span> <span class="bu">open</span>(<span class="st">&#39;sequences.csv&#39;</span>)
enzymes <span class="op">=</span> csv.reader(f, delimiter<span class="op">=</span>???)

<span class="co"># Create an empty dictionary that we will populate as we read the CSV</span>
<span class="co"># file</span>
dict_sequences <span class="op">=</span> {}

<span class="co"># For each of the enzymes in the file, associate the enzyme with its</span>
<span class="co"># sequence</span>
<span class="cf">for</span> enzyme <span class="op">in</span> enzymes:
    enzyme_id <span class="op">=</span> enzyme[???] <span class="co"># The ID of this enzyme</span>
    seq <span class="op">=</span> enzyme[???]       <span class="co"># The aminoacid sequence of this enzyme</span>
    dict_sequences[enzyme_id] <span class="op">=</span> seq</code></pre></div></li>
<li><p>Agora que temos o dicionário, vamos procurar as enzimas cujas sequências contêm três alaninas consecutivas:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="co"># We import the re module to handle regular expressions</span>
<span class="im">import</span> re

<span class="co"># Define here your regular expression</span>
reg_expr <span class="op">=</span> <span class="vs">r&#39;???&#39;</span>

<span class="co"># For each enzyme, retrieve their sequence and determine whether</span>
<span class="co"># the sequence matches three consecutive alanines</span>
<span class="cf">for</span> enzyme <span class="op">in</span> dict_sequences:
    <span class="co"># Retrieve the aminoacid sequence</span>
    seq <span class="op">=</span> ???

    <span class="co"># Determine whether the sequence matches the pattern</span>
    <span class="cf">if</span> re.search(reg_expr, seq):
        <span class="bu">print</span> <span class="st">&#39;The enzyme &#39;</span> <span class="op">+</span> ??? <span class="op">+</span> <span class="st">&#39; matches the expression &#39;</span> <span class="op">+</span> reg_expr</code></pre></div></li>
<li><p>Modifique o código acima para gravar os identificadores e sequências de aminoácidos num ficheiro <code>relevant_sequences_1.csv</code>, em vez de escrever no ecrã. Refira-se ao módulo 3, passo 5 se necessitar de se relembrar de como escrever um ficheiro CSV.</p></li>
<li><p>Altere a expressão regular no <em>script</em> para encontrar outros padrões. Para cada um destes padrões, grave os identificadores e sequências no ficheiro <code>relevant_sequences_2.csv</code> e <code>relevant_sequences_3.csv</code> respetivamente.</p>
<ol type="a">
<li><p>Sequências onde os primeiros 5 aminoácidos são não-polares.</p></li>
<li><p>Sequências que contêm uma metionina, seguida de qualquer aminoácido, seguida de uma serina ou uma prolina.</p></li>
</ol></li>
<li><p>Execute o código e estude os ficheiros criados. Correspondem ao que esperava ver?</p></li>
<li><p>Certifique-se de que mantém uma cópia dos ficheiros <code>relevant_sequences_1.csv</code>, <code>relevant_sequences_2.csv</code> e <code>relevant_sequences_3.csv</code> para si, assim como do <em>script</em> <code>module5.py</code>, de forma a que os possa usar nos próximos módulos. Por exemplo, envie-os para si por email ou faça o upload para a Dropbox.</p></li>
</ol>
<h2 id="após-a-aula-4">Após a aula:</h2>
<ol type="1">
<li><p>Escreva uma expressão regular alternativa à definida no passo 1, mantendo o significado mas usando elementos de expressões regulares diferentes.</p></li>
<li><p>Imagine que quer aplicar a primeira expressão regular usada neste módulo (3 alaninas consecutivas) ao ficheiro <code>relevant_sequences_2.csv</code> em vez de <code>sequences.csv</code>. Altere o <em>script</em> Python para acomodar estas alterações. Verifique se o resultado é igual ao que tinha obtido no ficheiro <code>relevant_sequences_1.csv</code>.</p></li>
</ol>
<p><strong>Nota</strong>: Para os alunos que queiram explorar expressões regulares em mais detalhe, propomos o seguinte exercício:<br> Qual a expressão regular que descreve um grupo de ligação ao GTP? Este é um grupo complexo que consiste em três sub-sequências:</p>
<ul>
<li>a primeira é <code>GXXXXGK</code>,</li>
<li>a segunda é <code>DXXG</code>, e</li>
<li>a terceira é <code>NKXD</code> ou <code>NKXW</code>.</li>
</ul>
<p>Entre o primeiro e o segundo grupos existem 40 a 80 aminoácidos ou 130 a 170 aminoácidos; entre o segundo e o terceiro grupo existem entre 40 a 80 aminoácidos. <small>[Fonte: Dever TE, Glynias MJ, Merrick WC (1987). PNAS 84(7), 1814-1818.]</small></p>
<h1 id="module6">Módulo 6 – Criar uma base de dados SQL</h1>
<h2 id="parte-i-um-pequeno-exemplo-para-começar">Parte I: Um pequeno exemplo para começar</h2>
<h3 id="objetivos-6">Objetivos:</h3>
<ul>
<li>Criar uma base de dados SQLite usando Python</li>
<li>Inserir e consultar dados na base de dados</li>
</ul>
<h3 id="input-5">Input:</h3>
<ul>
<li>Nenhum</li>
</ul>
<h3 id="output-5">Output:</h3>
<ul>
<li>Ficheiro da base de dados: <code>example.db</code></li>
</ul>
<h3 id="passos-6">Passos:</h3>
<ol type="1">
<li><p>Primeiro crie uma base de dados vazia usando Python. Dê a este <em>script</em> o nome de <nobr><code>example.py</code>.</nobr></p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="co"># `sqlite3` is a package that can be used to create a file containing</span>
<span class="co"># a relational database. We use this package to create the database,</span>
<span class="co"># insert data in it and query the data.</span>

<span class="im">import</span> sqlite3

<span class="co"># To access a database, we need to connect to it. If the file does not</span>
<span class="co"># exist, one will be created</span>
connection <span class="op">=</span> sqlite3.<span class="ex">connect</span>(<span class="st">&#39;example.db&#39;</span>)</code></pre></div></li>
<li><p>Agora que temos uma base de dados vazia, vamos adicionar tabelas e algumas linhas. Adicione o seguinte código ao seu <em>script</em>:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="co"># We can now emit SQL commands to the opened database</span>

<span class="co"># First create a table to store student information</span>
connection.execute(<span class="st">&#39;&#39;&#39;</span>
<span class="st">    CREATE TABLE students (</span>
<span class="st">        id INTEGER PRIMARY KEY,</span>
<span class="st">        name TEXT,</span>
<span class="st">        age INTEGER</span>
<span class="st">    )</span>
<span class="st">&#39;&#39;&#39;</span>)

<span class="co"># Then add information to that table</span>
connection.execute(<span class="st">&#39;&#39;&#39;</span>
<span class="st">    INSERT INTO students (id, name, age)</span>
<span class="st">    VALUES (1, &#39;Alice&#39;, 20)</span>
<span class="st">&#39;&#39;&#39;</span>)

connection.execute(<span class="st">&#39;&#39;&#39;</span>
<span class="st">    INSERT INTO students (id, name, age)</span>
<span class="st">    VALUES (2, &#39;Brock&#39;, 21)</span>
<span class="st">&#39;&#39;&#39;</span>)

connection.execute(<span class="st">&#39;&#39;&#39;</span>
<span class="st">    INSERT INTO students (id, name, age)</span>
<span class="st">    VALUES (3, &#39;Chuck&#39;, 19)</span>
<span class="st">&#39;&#39;&#39;</span>)

<span class="co"># You can also insert data that is stored in variables</span>
student_id <span class="op">=</span> <span class="dv">4</span>
student_name <span class="op">=</span> <span class="st">&#39;Doris&#39;</span>
student_age <span class="op">=</span> <span class="dv">19</span>
connection.execute(<span class="st">&#39;&#39;&#39;</span>
<span class="st">    INSERT INTO students (id, name, age)</span>
<span class="st">    VALUES (?, ?, ?)</span>
<span class="st">&#39;&#39;&#39;</span>, (student_id, student_name, student_age))

<span class="co"># Ensure that the data is saved</span>
connection.commit()</code></pre></div></li>
<li><p>Finalmente, vamos certificar-nos que a base de dados contém a informação inserida:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="co"># We can also emit SELECT commands which will return data back to Python</span>

rows <span class="op">=</span> connection.execute(<span class="st">&#39;SELECT id, name, age FROM students&#39;</span>)

<span class="cf">for</span> row <span class="op">in</span> rows:
    student_id <span class="op">=</span> row[<span class="dv">0</span>]
    student_name <span class="op">=</span> row[<span class="dv">1</span>]
    student_age <span class="op">=</span> row[<span class="dv">2</span>]

    msg <span class="op">=</span> student_name <span class="op">+</span> <span class="st">&#39; is &#39;</span> <span class="op">+</span> <span class="bu">str</span>(student_age) <span class="op">+</span> <span class="st">&#39; years old&#39;</span>
    msg <span class="op">=</span> msg <span class="op">+</span> <span class="st">&#39; and has id #&#39;</span> <span class="op">+</span> <span class="bu">str</span>(student_id)

    <span class="bu">print</span> msg</code></pre></div></li>
<li><p>Verifique que este é o output produzido.</p>
<pre class="text"><code>Alice is 20 years old and has id #1
Brock is 21 years old and has id #2
Chuck is 19 years old and has id #3
Doris is 19 years old and has id #4</code></pre></li>
</ol>
<h2 id="part-ii-agora-com-dados-reais">Part II: Agora com dados reais</h2>
<h2 id="objetivos-7">Objetivos:</h2>
<ul>
<li>Desenhar um esquema de base de dados simples para guardar informação de vias metabólicas</li>
<li>Usar chaves estrangeiras</li>
</ul>
<h2 id="input-6">Input:</h2>
<ul>
<li>Nenhum</li>
</ul>
<h2 id="output-6">Output:</h2>
<ul>
<li>Ficheiro de base de dados: <code>pathways.db</code></li>
</ul>
<h2 id="passos-7">Passos:</h2>
<ol type="1">
<li><p>AGora que já sabe criar uma base de dados e criar as suas tabelas, vamos começar uma nova base de dados no ficheiro <code>pathways.db</code> com três tabelas. Primeiro, crie um <em>script</em> <code>module6.py</code> com o seguinte código:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> sqlite3

connection <span class="op">=</span> sqlite3.<span class="ex">connect</span>(<span class="st">&#39;pathways.db&#39;</span>)

<span class="co"># Let&#39;s create the three tables.</span>

<span class="co"># This contains information about the pathway</span>
connection.execute(<span class="st">&#39;&#39;&#39;</span>
<span class="st">    CREATE TABLE path (</span>
<span class="st">        id VARCHAR(255) PRIMARY KEY,</span>
<span class="st">        name VARCHAR(255) NOT NULL,</span>
<span class="st">        class VARCHAR(255) NOT NULL</span>
<span class="st">    )</span>
<span class="st">&#39;&#39;&#39;</span>)

<span class="co"># This contains information about the enzymes</span>
connection.execute(<span class="st">&#39;&#39;&#39;</span>
<span class="st">    CREATE TABLE enzyme (</span>
<span class="st">        id VARCHAR(255) PRIMARY KEY,</span>
<span class="st">        sequence TEXT NOT NULL</span>
<span class="st">    )</span>
<span class="st">&#39;&#39;&#39;</span>)

<span class="co"># This associates each pathway with its enzymes</span>
connection.execute(<span class="st">&#39;&#39;&#39;</span>
<span class="st">    CREATE TABLE path_enzyme (</span>
<span class="st">        path_id VARCHAR(255),</span>
<span class="st">        enzyme_id VARCHAR(255),</span>
<span class="st">        PRIMARY KEY (path_id, enzyme_id),</span>
<span class="st">        FOREIGN KEY (path_id) REFERENCES path (id),</span>
<span class="st">        FOREIGN KEY (enzyme_id) REFERENCES enzyme (id)</span>
<span class="st">    )</span>
<span class="st">&#39;&#39;&#39;</span>)</code></pre></div></li>
<li><p>Agora vamos inserir os dados nestas três tabelas. Como exemplo, vamos inserir apenas uma via e duas enzimas dessa via. Se necessário, consulte os ficheiros criados nos módulos anteriores para encontrar o nome da via <code>hsa00730</code> e as enzimas que fazem parte dela.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">connection.execute(<span class="st">&#39;&#39;&#39;</span>
<span class="st">    INSERT INTO path (id, name, class)</span>
<span class="st">    VALUES (&#39;hsa00730&#39;, &#39;???&#39;, &#39;???&#39;);</span>
<span class="st">&#39;&#39;&#39;</span>)

connection.execute(<span class="st">&#39;&#39;&#39;</span>
<span class="st">    INSERT INTO enzyme (id, sequence)</span>
<span class="st">    VALUES (&#39;Q53FP3&#39;,&#39;???&#39;);</span>
<span class="st">&#39;&#39;&#39;</span>)

connection.execute(<span class="st">&#39;&#39;&#39;</span>
<span class="st">    INSERT INTO enzyme (id, sequence)</span>
<span class="st">    VALUES (&#39;???&#39;,&#39;???&#39;);</span>
<span class="st">&#39;&#39;&#39;</span>)

connection.execute(<span class="st">&#39;&#39;&#39;</span>
<span class="st">    INSERT INTO path_enzyme (path_id, enzyme_id)</span>
<span class="st">    VALUES (&#39;hsa00730&#39;,&#39;???&#39;);</span>
<span class="st">&#39;&#39;&#39;</span>)

connection.execute(<span class="st">&#39;&#39;&#39;</span>
<span class="st">    INSERT INTO path_enzyme (path_id, enzyme_id)</span>
<span class="st">    VALUES (&#39;???&#39;,&#39;???&#39;);</span>
<span class="st">&#39;&#39;&#39;</span>)

<span class="co"># Ensure that the data is saved</span>
connection.commit()</code></pre></div></li>
<li><p>Por fim, vamos assegurar-nos que as tabelas contêm os dados que lá colocámos. Para tal, como exemplo, vamos selecionar as enzimas de cada via.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">rows <span class="op">=</span> connection.execute(<span class="st">&#39;SELECT id, sequence FROM enzymes&#39;</span>)
<span class="cf">for</span> row <span class="op">in</span> rows:
    enzyme_id <span class="op">=</span> row[<span class="dv">0</span>]
    enzyme_sequence <span class="op">=</span> row[<span class="dv">1</span>]

    <span class="bu">print</span> enzyme_id <span class="op">+</span> <span class="st">&#39; starts with &#39;</span> <span class="op">+</span> enzyme_sequence[:<span class="dv">5</span>]</code></pre></div></li>
<li><p>Verifique que o output corresponde ao seguinte:</p>
<pre class="text"><code>Q53FP3 starts with MLLRA
Q9Y697 starts with MLLRA</code></pre></li>
<li><p>Certifique-se de que mantém uma cópia do ficheiro <code>pathways.db</code> para si, assim como do <em>script</em> <code>module6.py</code>, de forma a que os possa usar nos próximos módulos. Por exemplo, envie-os para si por email ou faça o upload para a Dropbox.</p></li>
</ol>
<h2 id="após-a-aula-5">Após a aula:</h2>
<ol type="1">
<li><p>Verifique que a chave primária da tabela <code>path_enzyme</code> tem dois atributos e explique porquê.</p></li>
<li><p>Modifique o esquema da base de dados para que possa guardar também o nome de cada enzima e a sua posição na via metabólica (um número inteiro).</p></li>
<li><p>Altere o código do passo 3 para que verifique também o conteúdo das tabelas <code>paths</code> e <code>path_enzyme</code>.</p></li>
</ol>
<h1 id="module7">Módulo 7 – Inserção de dados CSV</h1>
<h2 id="objetivos-8">Objetivos:</h2>
<ul>
<li>Copiar dados de CSV para a base de dados</li>
<li>Consultar os dados com critérios de seleção complexos</li>
</ul>
<h2 id="input-7">Input:</h2>
<ul>
<li>Ficheiro: <a href="files/selected2.csv">selected2.csv</a>
<ul>
<li>criado no módulo 3</li>
</ul></li>
<li>Ficheiro: <a href="files/sequences.csv">sequences.csv</a>
<ul>
<li>criado no módulo 3</li>
</ul></li>
<li>Ficheiro: <a href="files/pathways.db">pathways.db</a>
<ul>
<li>criado no módulo 6</li>
</ul></li>
</ul>
<h2 id="output-7">Output:</h2>
<ul>
<li>Ficheiro: <code>results_1.csv</code></li>
<li>Ficheiro: <code>results_2.csv</code></li>
<li>Ficheiro: <code>results_3.csv</code></li>
<li>Ficheiro: <code>results_4.csv</code></li>
</ul>
<h2 id="passos-8">Passos:</h2>
<ol type="1">
<li><p>Crie um novo <em>script</em> Python <code>module7.py</code> que abre a base de dados criada no módulo anterior e remove as linhas das tabelas.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> sqlite3

connection <span class="op">=</span> sqlite3.<span class="ex">connect</span>(<span class="st">&#39;pathways.db&#39;</span>)

<span class="co"># Erase all data from the three tables</span>
connection.execute(<span class="st">&#39;DELETE FROM path_enzyme&#39;</span>)
connection.execute(<span class="st">&#39;DELETE FROM paths&#39;</span>)
connection.execute(<span class="st">&#39;DELETE FROM enzymes&#39;</span>)

<span class="co"># Save the deletions</span>
connection.commit()</code></pre></div></li>
<li><p>Adicione o código seguinte ao <em>script</em>, o qual lê os dados de cada via metabólica e adicionam-nos à base de dados.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> csv

<span class="co"># Read the pathways from the file from module 3</span>
f <span class="op">=</span> <span class="bu">open</span>(<span class="st">&#39;selected2.csv&#39;</span>)
paths <span class="op">=</span> csv.reader(f, delimiter<span class="op">=</span>???)

<span class="co"># For each pathway, insert its information into the database</span>
<span class="cf">for</span> path <span class="op">in</span> paths:
    <span class="co"># Extract the pathway information from the `path` variable</span>
    path_id <span class="op">=</span> path[<span class="dv">0</span>]
    path_name <span class="op">=</span> ???
    path_class <span class="op">=</span> ???

    <span class="co"># Insert into the database using the `?` notation</span>
    connection.execute(<span class="st">&#39;&#39;&#39;</span>
<span class="st">        INSERT INTO paths (id, name, class)</span>
<span class="st">        VALUES (?, ?, ?)</span>
<span class="st">    &#39;&#39;&#39;</span>, (path_id, path_name, path_class))

<span class="co"># Save the changes</span>
connection.commit()</code></pre></div></li>
<li><p>Vamos fazer o mesmo com as enzimas:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="co"># Now do the same for the enzymes</span>
f <span class="op">=</span> <span class="bu">open</span>(<span class="st">&#39;sequences.csv&#39;</span>)
enzymes <span class="op">=</span> csv.reader(f, delimiter<span class="op">=</span>???)

enzymes_inserted <span class="op">=</span> [] <span class="co"># Keep a list of the enzymes already inserted</span>

<span class="cf">for</span> enzyme <span class="op">in</span> enzymes:
    enzyme_id <span class="op">=</span> ???
    enzyme_sequence <span class="op">=</span> ???

    <span class="co"># Check to see if the enzyme has been added before</span>
    <span class="cf">if</span> enzyme_id <span class="op">not</span> <span class="op">in</span> enzymes_inserted:
        connection.execute(<span class="st">&#39;&#39;&#39;</span>
<span class="st">            INSERT INTO enzymes (id, sequence)</span>
<span class="st">            VALUES (?, ?)</span>
<span class="st">        &#39;&#39;&#39;</span>, (enzyme_id, enzyme_sequence))

        <span class="co"># Add this enzyme to the list of enzymes already inserted</span>
        enzymes_inserted.append(enzyme_id)

<span class="co"># Save the changes</span>
connection.commit()</code></pre></div></li>
<li><p>E agora vamos inserir na base de dados a informação que associa cada via às suas enzimas:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="co"># Which file do we need to read in order to relate pathways with enzymes?</span>
f <span class="op">=</span> <span class="bu">open</span>(???)

paths <span class="op">=</span>  csv.reader(f, delimiter<span class="op">=</span>???)

<span class="cf">for</span> path <span class="op">in</span> paths:
    path_id <span class="op">=</span> path[<span class="dv">0</span>]
    enzyme_list <span class="op">=</span> path[<span class="dv">3</span>].split(<span class="st">&#39;|&#39;</span>)

    <span class="co"># For each enzyme, we need to add one line to the `path_enzyme` table</span>
    <span class="cf">for</span> enzyme_id <span class="op">in</span> enzyme_list:
        connection.execute(<span class="st">&#39;&#39;&#39;</span>
<span class="st">            INSERT INTO path_enzyme (path_id, enzyme_id)</span>
<span class="st">            VALUES (?, ?)</span>
<span class="st">        &#39;&#39;&#39;</span>, (path_id, enzyme_id))

connection.commit()</code></pre></div></li>
<li><p>Com um comando SQL, consulte os dados das vias metabólicas e imprima o identificar e o nome no terminal:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">rows <span class="op">=</span> connection.execute(<span class="st">&#39;SELECT ??? FROM ???&#39;</span>)

<span class="co"># For each selected pathway, print the id and the name of the pathway</span>
<span class="cf">for</span> row <span class="op">in</span> rows:
    path_id <span class="op">=</span> row[???]
    path_name <span class="op">=</span> row[???]

    <span class="bu">print</span> <span class="st">&#39;Path &#39;</span> <span class="op">+</span> path_id <span class="op">+</span> <span class="st">&#39; is named &quot;&#39;</span> <span class="op">+</span> path_name <span class="op">+</span> <span class="st">&#39;&quot;&#39;</span></code></pre></div></li>
<li><p>Verifique que o output é</p>
<pre class="text"><code>Path hsa00730 is named &quot;Thiamine metabolism&quot;
Path hsa04122 is named &quot;Sulfur relay system&quot;</code></pre></li>
<li><p>O código anterior imprime a informação no terminal. Agora queremos gravar essa mesma informação no ficheiro CSV <code>results_1.csv</code>. Substitua o código do passo 5 por isto:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="co"># Let&#39;s open file &#39;results_1.csv&#39; in write mode</span>
f <span class="op">=</span> <span class="bu">open</span>(???, ???)
w <span class="op">=</span> csv.writer(f, delimiter<span class="op">=</span>???)

rows <span class="op">=</span> connection.execute(<span class="st">&#39;SELECT ??? FROM ???&#39;</span>)

<span class="co"># For each selected pathway, save it to the file</span>
<span class="cf">for</span> row <span class="op">in</span> rows:
    w.writerow(row)</code></pre></div></li>
<li><p>Selecione agora as enzimas cujo identificar começa com Q e grave-as no ficheiro <code>results_2.csv</code>. A receita é a mesma, apenas mudando o nome do ficheiro e o comando de consulta. Pode usar a seguinte consulta, substituindo onde for apropriado:</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> ??? <span class="kw">FROM</span> enzymes <span class="kw">WHERE</span> ??? <span class="kw">LIKE</span> <span class="ot">&quot;Q%&quot;</span></code></pre></div></li>
<li><p>Agora vamos cruzar informação de várias tabelas. Duplique e adapte o código do passo anterior, usando o seguinte comando SQL para selecionar as sequências das enzimas de cada via metabólica, e grave o resultado no ficheiro <code>results_3.csv</code>:</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> paths.name, enzymes.???
<span class="kw">FROM</span> paths, enzymes, path_enzyme
<span class="kw">WHERE</span> paths.id = path_enzyme.path_id
  <span class="kw">AND</span> enzymes.id = path_enzyme.enzyme_id</code></pre></div></li>
<li><p>SQL permite consultas mais complexas. Use a consulta seguinte para gravar o identificador e o nome das vias metabólicas associadas a pelo menos 15 enzimas. Grave o resultado no ficheiro <code>results_4.csv</code>.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> paths.id, paths.name
<span class="kw">FROM</span> paths, path_enzymes
<span class="kw">GROUP</span> <span class="kw">BY</span> path_id <span class="kw">HAVING</span> <span class="fu">COUNT</span>(*) &gt;= <span class="dv">15</span></code></pre></div></li>
</ol>
<h2 id="após-a-aula-6">Após a aula:</h2>
<ol type="1">
<li><p>Determine a razão para usar uma lista <code>enzymes_inserted</code> no passo 3.<br> <strong>Dica</strong>: tente remover o uso da lista, execute o <em>script</em> e observe que o código falha com uma exceção <code>constraint failed</code>.</p></li>
<li><p>Muitos dos passos deste módulo consistem em código repetido.</p>
<ol type="a">
<li><p>Crie uma função <code>run_sql</code> que aceita dois argumentos: um comando SQL e o nome de um ficheiro.</p></li>
<li><p>A implementação desta função deve executar o comando SQL fornecido e gravar o resultado obtido num ficheiro CSV.</p></li>
<li><p>Altere o código deste módulo de forma a que use a função <code>run_sql</code> em vez de repetir código. <strong>Dica</strong>: Os passos 7 a 10 serão simplesmente a chamada à função.</p></li>
</ol></li>
</ol>
<script src="https://code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>
<script>

// Replace all instances of "???" inside <code> elements with the HTML code:
// <span class="blank">?</span>
$("code").html(function () {
    return $(this).html().replace(/\?\?\?/g, "<span class=\"blank\">?</span>");
});

// "print" is a builtin in python3 but a keyworkd in python2.
// Let's make sure this change happens
$("span.bu").each(function() {
    if ($(this).text() == "print") {
        $(this).removeClass('bu');
        $(this).addClass('kw');
    }
})

</script>
</body>
</html>
